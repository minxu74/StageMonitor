<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Data Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .last-update {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
        .data-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .refresh-btn {
            margin-left: 10px;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>JSON Data Viewer</h1>
        <div class="d-flex justify-content-between align-items-center">
            <div class="last-update" id="lastUpdate">
                Last update: Never
            </div>
            <button id="refreshBtn" class="btn btn-primary refresh-btn">
                <span id="refreshIcon" class="spinner-border spinner-border-sm d-none"></span>
                Refresh Now
            </button>
        </div>
        
        <div class="data-container mt-3">
            <div id="loadingMessage" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading data...</p>
            </div>
            <div id="dataDisplay" class="d-none">
                <h3>Current Data</h3>
                <pre id="jsonData"></pre>
            </div>
            <div id="errorDisplay" class="alert alert-danger d-none"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dataDisplay = document.getElementById('dataDisplay');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorDisplay = document.getElementById('errorDisplay');
            const jsonDataElement = document.getElementById('jsonData');
            const lastUpdateElement = document.getElementById('lastUpdate');
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');

            // Function to format timestamp
            function formatTime(timestamp) {
                if (!timestamp) return 'Never';
                const date = new Date(timestamp * 1000);
                return date.toLocaleString();
            }

            // Function to fetch and display data
            async function fetchData() {
                try {
                    // Show loading state
                    dataDisplay.classList.add('d-none');
                    errorDisplay.classList.add('d-none');
                    loadingMessage.classList.remove('d-none');
                    
                    const response = await fetch('/api/data');
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    // Display the data
                    jsonDataElement.textContent = JSON.stringify(result.data, null, 2);
                    lastUpdateElement.textContent = `Last update: ${formatTime(result.last_update)}`;
                    
                    // Show data
                    loadingMessage.classList.add('d-none');
                    dataDisplay.classList.remove('d-none');
                } catch (error) {
                    console.error('Error fetching data:', error);
                    loadingMessage.classList.add('d-none');
                    errorDisplay.textContent = `Error: ${error.message}`;
                    errorDisplay.classList.remove('d-none');
                }
            }

            // Manual refresh button
            refreshBtn.addEventListener('click', async function() {
                refreshIcon.classList.remove('d-none');
                document.body.classList.add('loading');
                
                try {
                    const response = await fetch('/api/force-update', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        await fetchData();
                    } else {
                        throw new Error(result.message || 'Update failed');
                    }
                } catch (error) {
                    console.error('Error forcing update:', error);
                    errorDisplay.textContent = `Error: ${error.message}`;
                    errorDisplay.classList.remove('d-none');
                } finally {
                    refreshIcon.classList.add('d-none');
                    document.body.classList.remove('loading');
                }
            });

            // Initial data load
            fetchData();
            
            // Set up periodic refresh (every hour)
            setInterval(fetchData, 3600000);
        });
    </script>
</body>
</html>
