<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Data Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.4.3/dist/css/tabulator.min.css" rel="stylesheet">
    <style>
        .tab-content {
            padding: 20px;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            border-radius: 0 0 5px 5px;
        }
        #currentDataTable, #historyTable {
            background: white;
            margin-top: 10px;
        }
        .last-update {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1>JSON Data Viewer</h1>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="last-update" id="lastUpdate">Last update: Never</div>
            <button id="refreshBtn" class="btn btn-primary">
                <span id="refreshSpinner" class="spinner-border spinner-border-sm d-none"></span>
                Refresh Now
            </button>
        </div>

        <ul class="nav nav-tabs" id="dataTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#currentData">Current Data</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#historicalData">History</a>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="currentData">
                <div id="loadingIndicator" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>Loading data...</p>
                </div>
                <div id="currentDataTable"></div>
            </div>
            <div class="tab-pane fade" id="historicalData">
                <div id="historyTable"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.4.3/dist/js/tabulator.min.js"></script>
    <script>
        // Initialize tables
        const currentTable = new Tabulator("#currentDataTable", {
            layout: "fitColumns",
            placeholder: "No data available",
            columns: [
                {title: "Key", field: "key", headerFilter: true},
                {title: "Value", field: "value", headerFilter: true}
            ]
        });

        const historyTable = new Tabulator("#historyTable", {
            layout: "fitColumns",
            placeholder: "No historical data available",
            columns: [
                {title: "ID", field: "id", width: 80},
                {title: "Timestamp", field: "timestamp", headerFilter: true},
                {title: "Data", field: "data", formatter: "textarea"}
            ]
        });

        // Helper function to flatten JSON for table display
        function flattenData(data) {
            return Object.entries(data).map(([key, value]) => ({
                key,
                value: typeof value === 'object' ? JSON.stringify(value, null, 2) : value
            }));
        }

        // Fetch and display current data
        async function loadCurrentData() {
            try {
                document.getElementById('loadingIndicator').classList.remove('d-none');
                const response = await fetch('/api/data');
                if (!response.ok) throw new Error(await response.text());
                
                const data = await response.json();
                currentTable.replaceData(flattenData(data.data));
                document.getElementById('lastUpdate').textContent = 
                    `Last update: ${new Date(data.last_update).toLocaleString()}`;
            } catch (error) {
                console.error("Error loading current data:", error);
                alert("Failed to load current data: " + error.message);
            } finally {
                document.getElementById('loadingIndicator').classList.add('d-none');
            }
        }

        // Fetch and display historical data
        async function loadHistoricalData() {
            try {
                const response = await fetch('/api/history');
                if (!response.ok) throw new Error(await response.text());
                historyTable.replaceData(await response.json());
            } catch (error) {
                console.error("Error loading history:", error);
                alert("Failed to load history: " + error.message);
            }
        }

        // Manual refresh
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const spinner = document.getElementById('refreshSpinner');
            try {
                spinner.classList.remove('d-none');
                const response = await fetch('/api/refresh', {method: 'POST'});
                if (!response.ok) throw new Error(await response.text());
                await loadCurrentData();
            } catch (error) {
                console.error("Refresh failed:", error);
                alert("Refresh failed: " + error.message);
            } finally {
                spinner.classList.add('d-none');
            }
        });

        // Load data when switching tabs
        document.getElementById('dataTabs').addEventListener('shown.bs.tab', (event) => {
            if (event.target.getAttribute('href') === '#historicalData') {
                loadHistoricalData();
            }
        });

        // Initial load
        loadCurrentData();
    </script>
</body>
</html>
